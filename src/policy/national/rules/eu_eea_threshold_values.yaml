---
_rule:
  domain: TH
  severity: ERROR

logic: threshold_engine
  
currency: NOK

params:
  _dependencies:
    fields: 
      value: 
        - "estimated_value_proc"
        - "framework_maximum_value_proc"
      legal_basis: "legal_basis_noid"
      legal_basis_descriptions:
        - legal_basis_description: "legal_basis_noid_description_nor"
          lang: "nor"
        - legal_basis_description: "legal_basis_noid_description_eng"
          lang: "eng"
      buyer_legal_type: "buyer_legal_type"
      contract_nature_main_proc: "contract_nature_main_proc"
      main_cpv_proc: "main_classification_proc"
    external_data:
      - file: "rules/legal_basis_procedure.yaml"
        id: "lb_registry"

  rules:
    # --- FOA Del II: Bygge- og anleggsarbeider (works) tak ---
    - scope: FOA
      kind: national_to_eu_out_of_range
      sub_kind: works
      context: 
        lb_scope: national_to_eu
        lt_filter: "any"
        nature: "works"
      cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 57_800_000"
      _description:
        nob: >-
          Verdien av anskaffelser av bygge- og anleggsarbeider overstiger
          EU/EØS-terskelverdiene i Anskaffelsesforskriftens Del 1 og 2.
          Anskaffelsen må derfor følge fullstendige prosedyreregler for
          utlysning på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av byggje- og anleggsarbeidar overstig
          EU/EØS-terskelverdiane i Anskaffingsforskriftas Del 1 og 2.
          Anskaffinga må derfor følgje fullstendige prosedyrereglar for
          utlysing på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured works exceeds the EU/EEA threshold
          values specified in Parts 1 and 2 of the Norwegian Public Procurement
          Regulations. The procurement therefore must follow complete procedure
          rules for publication at an EU level.
        eng_validate: false

    # --- FOA Del II: Særlige tjenester tak ---
    - scope: FOA
      kind: national_to_eu_out_of_range
      sub_kind: special_services
      context:
        lb_scope: national_to_eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-special-services"
      test: "value < 7_800_000"
      _description:
        nob: >-
          Verdien av anskaffelser av særlige tjenester overstiger
          EU/EØS-terskelverdiene i Anskaffelsesforskriftens Del 1 og 2.
          Anskaffelsen må derfor følge fullstendige prosedyreregler for
          utlysning på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av særlege tenester overstig
          EU/EØS-terskelverdiane i Anskaffingsforskriftas Del 1 og 2.
          Anskaffinga må derfor følgje fullstendige prosedyrereglar for
          utlysing på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured special services exceeds the
          EU/EEA threshold values specified in Parts 1 and 2 of the Norwegian
          Public Procurement Regulations. The procurement therefore must follow
          complete procedure rules for publication at an EU level.
        eng_validate: false
        
    # --- Blokkér FOA del II for Helse- og sosialtjenester (unntatt) ---
    - scope: FOA
      kind: national_to_eu_out_of_range
      sub_kind: health_social_services_exempt
      context:
        lb_scope: national_to_eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-health-social-services"
      test: "true" # Trigger alltid hvis kontekst og CPV matcher
      _description:
        nob: >-
          Anskaffelser av helse- og sosialtjenester er unntatt
          fra Anskaffelsesforskriftens Del II. Disse tjenestene
          følger Anskaffelsesforskriftens Del I for nasjonale
          anskaffelser, og har egne bestemmelser i forskriftens
          Del IV for anskaffelser over EU/EØS-terskelverdiene.
          Anskaffelsesforskriftens Del I og II er derfor
          ikke tillatt som lovhjemmel for slike anskaffelser.
        nob_verify: false
        nno: >-
          Anskaffingar av helse- og sosialtenester er unntatt
          frå Anskaffingsforskriftas Del II. Desse tenestane
          følgjer Anskaffingsforskriftas Del I for nasjonale
          anskaffingar, og har eigne bestemmelsar i
          forskriftas Del IV for anskaffingar over
          EU/EØS-terskelverdiane. Anskaffingsforskriftas
          Del I og II er derfor ikkje ein tillatt lovheimel
          for denne typen anskaffingar.
        nno_verify: false
        eng: >-
          Procurements of social and health services are exempt
          from Part II of the Norwegian Public Procurement
          Regulations. These services follow Part I of the
          Norwegian Public Procurement Regulations for national
          procurements, and, in the event that the procurement
          exceeds the EU/EEA thresholds, they are governed
          by Part IV. Thus, the Norwegian Public Procurement
          Regulations Part I and II is not a permitted legal
          basis for this type of procurement.
        eng_verify: false

    # --- FOA: Helse- og sosialtjenester (Kun aktuelt med del I) ---
    - scope: FOA
      kind: eu_threshold_exceeded
      sub_kind: health_social_services
      context: 
        lb_scope: eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-health-social-services"
      test: "value < 7_800_000"
      _description:
        nob: >-
          Verdien av anskaffelser av helse- og sosialtjenester overstiger
          EU/EØS-terskelverdiene i Anskaffelsesforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av helse- og sosialtenester overstig
          EU/EØS-terskelverdiane i Anskaffingsforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured health and social services exceeds the
          EU/EEA threshold values specified in the Norwegian Public Procurement
          Regulations. The procurement therefore must follow complete procedure
          rules for publication at an EU level.
        eng_validate: false
      
    # FOA Del II - Statlig (CGA) tak
    - scope: FOA
      kind: national_to_eu_out_of_range
      sub_kind: goods_services_too_high_cga
      context:
        lb_scope: national_to_eu
        lt_filter: "contains:cga"
        nature: ["services", "supplies"]
      exclude_cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-special-services"
        - file: "foa_cpv_registry.yaml"
          key: "cpv-health-social-services"
        - file: "foa_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 1490000"
      _description: 
        nob: >-
          Verdien av anskaffelsen overstiger verdigrensene i
          Anskaffelsesforskriften Del 2, for statlige eller
          statsstyrte oppdragsgivere. Anskaffelsen må derfor
          følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga overstig verdigrensane i
          Anskaffingsforskrifta Del 2, for statlege eller
          statsstyrte oppdragsgjevare. Anskaffinga må derfor
          følgje fullstendige prosedyrereglar for utlysning på
          EU-nivå.
        eng: >-
          The value of the procurement exceeds the value limits
          of the Norwegian Public Procurement Regulations, Part 2,
          for contracting authorities governed by a central
          governmental agency.
          The procurement therefore must follow complete procedure
          rules for publication at an EU level.
        eng_validate: false
    
    # FOA Del II - Ikke-statlig (Non-CGA) tak
    - scope: FOA
      kind: national_to_eu_out_of_range
      sub_kind: goods_services_too_high_non_cga
      context:
        lb_scope: national_to_eu
        lt_filter: "not_contains:cga"
        nature: ["services", "supplies"]
      exclude_cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-special-services"
        - file: "foa_cpv_registry.yaml"
          key: "cpv-health-social-services"
        - file: "foa_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 2_300_000"
      _description:
        nob: >-
          Verdien av anskaffelsen overstiger verdigrensene i
          Anskaffelsesforskriften Del 2, for kommunale eller
          fylkeskommunale oppdragsgivere. Anskaffelsen må derfor
          følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga overstig verdigrensane i
          Anskaffingsforskrifta Del 2, for kommunale eller
          fylkeskommunale oppdragsgjevare. Anskaffinga må derfor
          følgje fullstendig prosedyrereglar for utlysning på
          EU-nivå.
        eng: >-
          The value of the procurement exceeds the value limits
          of the Norwegian Public Procurement Regulations, Part 2,
          for contracting authorities which are or which are governed
          by counties or municipal bodies.
          The procurement therefore must follow complete procedure
          rules for publication at an EU level.
        eng_validate: false
        
        
    # FOA Del 1 - ikke helse- og sosial tjenester - Verditak
    - scope: FOA
      kind: national_limit_exceeded
      sub_kind: goods_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "services"
      exclude_cpv_import:
        - file: "foa_cpv_registry.yaml"
          key: "cpv-health-social-services"
      test: "value < 1_300_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av varer eller tjenester overstiger
          verdigrensene i Anskaffelsesforskriften Del 1. Anskaffelsen
          må derfor som minimum følge prosedyreregler for utlysning etter
          Anskaffelsesforskriftens Del 1 og 2. 
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av varer eller tenester overstig terskelverdien
          for Anskaffingsforskriftas Del 1. Anskaffinga må derfor som minimum
          følgje prosedyrereglar for utlysing etter Anskaffingsforskriftas
          Del 1 og 2.
        nno_verify: false
        eng: >-
          The value of the procured goods or services exceeds the threshold
          value specified in Part 1 of the Norwegian Public Procurement
          Regulations. The procurement therefore must, at least, follow
          the procedure rules stated in Parts 1 and 2 of the Norwegian Public
          Procurement Regulations.
        eng_validate: false
        
    # --- KON: Bygge- og anleggsarbeider (works) ---
    - scope: KON
      kind: eu_threshold_exceeded
      sub_kind: works
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "works"
      cpv_import:
        - file: "kon_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 57_800_000"
      _description:
        nob: >-
          Verdien av anskaffelser av bygge- og anleggsarbeider overstiger
          EU/EØS-terskelverdiene i Konsesjonskontraktforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av byggje- og anleggsarbeidar overstig
          EU/EØS-terskelverdiane i Konsesjonskontraktforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured works exceeds the EU/EEA threshold
          values specified in the Norwegian Concession Contract Regulations.
          The procurement therefore must follow complete procedure rules
          for publication at an EU level.
        eng_validate: false
        
    # --- KON: Særlige tjenester ---
    - scope: KON
      kind: eu_threshold_exceeded
      sub_kind: special_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "kon_cpv_registry.yaml"
          key: "cpv-special-services"
      test: "value < 57_800_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av særlige tjenester overstiger
          EU/EØS-terskelverdiene i Konsesjonskontraktforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av særlege tenester overstig
          EU/EØS-terskelverdiane i Konsesjonskontraktforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured special services exceeds the EU/EEA threshold
          values specified in the Norwegian Concession Contract Regulations.
          The procurement therefore must follow complete procedure rules
          for publication at an EU level.
        eng_validate: false
      
    # --- KON: Helse- og sosialtjenester ---
    - scope: KON
      kind: eu_threshold_exceeded
      sub_kind: health_social_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "kon_cpv_registry.yaml"
          key: "cpv-health-social-services"
      test: "value < 57_800_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av helse- og sosialtjenester overstiger
          EU/EØS-terskelverdiene i Konsesjonskontraktforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av helse- og sosialtenester overstig
          EU/EØS-terskelverdiane i Konsesjonskontraktforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured social and health services exceeds the
          EU/EEA threshold values specified in the Norwegian Concession
          Contract Regulations. The procurement therefore must follow complete
          procedure rules for publication at an EU level.
        eng_validate: false
        
    # --- KON: Generelle varer og tjenester ---
    - scope: KON
      kind: eu_threshold_exceeded
      sub_kind: goods_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: ["services", "supplies"]
      exclude_cpv_import:
        - file: "kon_cpv_registry.yaml"
          key: "cpv-health-social-services"
        - file: "kon_cpv_registry.yaml"
          key: "cpv-special-services"
        - file: "kon_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 57_800_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av varer og tjenester overstiger
          EU/EØS-terskelverdiene i Konsesjonskontraktforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av varer og tenester overstig
          EU/EØS-terskelverdiane i Konsesjonskontraktforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured goods and services exceeds the
          EU/EEA threshold values specified in the Norwegian Concession
          Contract Regulations. The procurement therefore must follow complete
          procedure rules for publication at an EU level.
        eng_validate: false


    # --- FOR: Bygge- og anleggsarbeider (works) ---
    - scope: FOR
      kind: eu_threshold_exceeded
      sub_kind: works
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "works"
      cpv_import:
        - file: "for_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 57_800_000"
      _description:
        nob: >-
          Verdien av anskaffelser av bygge- og anleggsarbeider overstiger
          EU/EØS-terskelverdiene i Forsyningsforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av byggje- og anleggsarbeidar overstig
          EU/EØS-terskelverdiane i Forsyningsforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured works exceeds the EU/EEA threshold
          values specified in the Norwegian Supplies Regulations.
          The procurement therefore must follow complete procedure rules
          for publication at an EU level.
        eng_validate: false
        
    # --- FOR: Særlige tjenester ---
    - scope: FOR
      kind: eu_threshold_exceeded
      sub_kind: special_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "for_cpv_registry.yaml"
          key: "cpv-special-services"
      test: "value < 10_400_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av særlige tjenester overstiger
          EU/EØS-terskelverdiene i Forsyningsforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av særlege tenester overstig
          EU/EØS-terskelverdiane i Forsyningsforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured special services exceeds the EU/EEA threshold
          values specified in the Norwegian Supplies Contract Regulations.
          The procurement therefore must follow complete procedure rules
          for publication at an EU level.
        eng_validate: false
      
    # --- FOR: Helse- og sosialtjenester ---
    - scope: FOR
      kind: eu_threshold_exceeded
      sub_kind: health_social_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: "services"
      cpv_import:
        - file: "for_cpv_registry.yaml"
          key: "cpv-health-social-services"
      test: "value < 10_400_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av helse- og sosialtjenester overstiger
          EU/EØS-terskelverdiene i Forsyningsforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av helse- og sosialtenester overstig
          EU/EØS-terskelverdiane i Forsyningsforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured social and health services exceeds the
          EU/EEA threshold values specified in the Norwegian Supplies
          Contract Regulations. The procurement therefore must follow complete
          procedure rules for publication at an EU level.
        eng_validate: false
        
      # --- FOR: Generelle varer og tjenester ---
    - scope: FOR
      kind: eu_threshold_exceeded
      sub_kind: goods_services
      context:
        lb_scope: eu
        lt_filter: "any"
        nature: ["services", "supplies"]
      exclude_cpv_import:
        - file: "for_cpv_registry.yaml"
          key: "cpv-health-social-services"
        - file: "for_cpv_registry.yaml"
          key: "cpv-special-services"
        - file: "for_cpv_registry.yaml"
          key: "cpv-works"
      test: "value < 4_600_000"
      _description:
        nob: >-
          Verdien av anskaffelsen av varer og tjenester overstiger
          EU/EØS-terskelverdiene i Forsyningsforskriften. Anskaffelsen
          må derfor følge fullstendige prosedyreregler for utlysning
          på EU-nivå.
        nob_verify: false
        nno: >-
          Verdien av anskaffinga av varer og tenester overstig
          EU/EØS-terskelverdiane i Forsyningsforskrifta. Anskaffinga
          må derfor følgje fullstendige prosedyrereglar for utlysing
          på EU-nivå.
        nno_verify: false
        eng: >-
          The value of the procured goods and services exceeds the
          EU/EEA threshold values specified in the Norwegian Supplies
          Contract Regulations. The procurement therefore must follow complete
          procedure rules for publication at an EU level.
        eng_validate: false
