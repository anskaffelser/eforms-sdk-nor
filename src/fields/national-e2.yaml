noticeTypes: E2

procedure-scope:
  - national-below-eea-threshold

include:
  - logical-groups/procedure-legal-basis.yaml
  - logical-groups/notice-versioning.yaml
  - logical-groups/notice-dispatch-datetime.yaml
  - logical-groups/notice-form-type.yaml
  - logical-groups/notice-official-language.yaml
  
fields:
  OPT-002-notice:
    pattern:
      value: ^eforms-sdk-\d\.\d#extended#urn:fdc:anskaffelser.no:2023:eforms:national$

rules:
  # /*/cbc:CustomizationID
  OPT-002-notice:
    - id: EFORMS-NOR-R001
      test: matches(normalize-space(),'^eforms-sdk-\d\.(\d{1,2})#extended#urn:fdc:anskaffelser.no:2023:eforms:national$')
      message: Customization identifier must match the Norwegian accepted identifier

  # /*/cbc:NoticeLanguageCode
  BT-702(a)-notice:
    - id: EFORMS-NOR-R002
      test: normalize-space() = ('BUL', 'CES', 'DAN', 'DEU', 'ELL', 'ENG', 'EST', 'FIN', 'FRA', 'GLE', 'HRV', 'HUN', 'ITA', 'LAV', 'LIT', 'MLT', 'NLD', 'POL', 'POR', 'RON', 'SLK', 'SLV', 'SPA', 'SWE', 'NOR', 'NOB', 'NNO')
      message: Main language must be Norwegian or one of the official languages.

  # /*/cac:AdditionalNoticeLanguage/cbc:ID
  BT-702(b)-notice:
    - id: EFORMS-NOR-R003
      test: normalize-space() = ('BUL', 'CES', 'DAN', 'DEU', 'ELL', 'ENG', 'EST', 'FIN', 'FRA', 'GLE', 'HRV', 'HUN', 'ITA', 'LAV', 'LIT', 'MLT', 'NLD', 'POL', 'POR', 'RON', 'SLK', 'SLV', 'SPA', 'SWE', 'NOR', 'NOB', 'NNO')
      message: Additional language must be Norwegian or one of the official languages.

  # /*/ext:UBLExtensions/ext:UBLExtension/ext:ExtensionContent/efext:EformsExtension/efac:NoticeSubType/cbc:SubTypeCode
  OPP-070-notice:
    - id: EFORMS-NOR-R010
      test: normalize-space() = ('N4', 'N16', 'N29')
      message: Notice type must be N4, N16 or N29.

  # /*
  ND-Root:
    - id: EFORMS-NOR-R004
      test: normalize-space(cbc:NoticeLanguageCode) = ('NOR', 'NOB', 'NNO') or (some $l in cac:AdditionalNoticeLanguage/cbc:ID satisfies normalize-space($l) = ('NOR', 'NOB', 'NNO')) # then true() else false())
      message: At least one of the official lingustic versions must be in Norwegian.

    - id: EFORMS-NOR-R007
      test: not(/*/ext:UBLExtensions/ext:UBLExtension/ext:ExtensionContent/efext:EformsExtension/efac:NonOfficialLanguages)
      message: Non-official languages are not used for national notices.

  # /*/cbc:IssueDate
  BT-05(a)-notice:
    # Copied from stage 6b
    - id: EFORMS-NOR-R801
      test: ((current-date() - xs:date(text())) le xs:dayTimeDuration('P2D')) and ((current-date() - xs:date(text())) ge xs:dayTimeDuration('-P1D'))
      message: Notice Dispatch Date must be between 0 and 24 hours before the current date.

  BT-131(d)-Lot:
    - id: EFORMS-NOR-R200
      test: normalize-space() = /*/cac:ProcurementProjectLot[cbc:ID/@schemeName='Lot']/cac:TenderingProcess/cac:TenderSubmissionDeadlinePeriod/cbc:EndDate[1]/normalize-space()
      message: All lots must have same deadline
    
  BT-131(t)-Lot:
    - id: EFORMS-NOR-R201
      test: normalize-space() = /*/cac:ProcurementProjectLot[cbc:ID/@schemeName='Lot']/cac:TenderingProcess/cac:TenderSubmissionDeadlinePeriod/cbc:EndTime[1]/normalize-space()
      message: All lots must have same deadline

included:
  mandatory:
    # ----------------------------
    # Notice related (BG-1 Notice)
    # ----------------------------
    BT-701-notice:
      - id: notice-identifier
        note: >
          See logical-group 'notice-versioning' for related elements.
        logical-group: notice-versioning
        test: >
          matches(
            lower-case(
              normalize-space(
                /*/cbc:ID[@schemeName='notice-id']
              )
            ),
            "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
          )
        message: Notice Identifier must be a valid UUID4.

    BT-757-notice:
      - id: notice-version
        note: >
          See logical-group 'notice-versioning' for related elements.
        logical-group: notice-versioning
        test: >
          matches(
            normalize-space(
              /*/cbc:VersionID
            ),
            "^[0-9]{2}$"
          )
        message: >
          Notice Version must be a left-zero-padded
          two digit integer.

    BT-03-notice:
      - id: form-type
        note: >
          See logical group 'notice-form-type' for related elements.
        logical-group: 'notice-form-type'
        test: >
          matches(
            /*/cbc:NoticeType/@listName
            ),
            {{ bt-03-notice-form-type-codes }}
          )
        message: >
          Form type must be chosen as a valid code from the codelist.

    BT-02-notice:
      - id: notice-type
        note: >
          See logical group 'notice-form-type' for related elements.
          Note that the '@listName' attribute of the XML element is
          mapped in BT-03-notice.
        logical-group: 'notice-form-type'
        test: >
          matches(
            /*/cbc:NoticeType
            ),
            {{ bt-02-notice-notice-type-codes }}
          )
        message: >
          Notice type must be chosen as a valid code from the codelist.

    BT-05(a)-notice:
      - id: dispatch-date
        note: >
          See logical group 'notice-dispatch-datetime' for related elements.
        logical-group: 'notice-dispatch-datetime'
        test: >
          matches(
            normalize-space(
              /*/cbc:IssueDate
            ),
            "^[0-9]{4}-[0-1][0-9]-[0-3][0-9]\+[0-1][0-9]:[0-5][0-9]$"
          )
        message: >
          Issue date must be provided as a split ISO 8601 datetime
          representation (non-standard date with offset).

    BT-05(b)-notice:
      - id: dispatch-time
        note: >
          See logical group 'notice-dispatch-datetime' for related elements.
        logical-group: 'notice-dispatch-datetime'
        test: >
          matches(
            normalize-space(
              /*/cbc:IssueTime
            ),
            "^[0-2][0-9]:[0-5][0-9]:[0-5][0-9]\+[0-1][0-9]:[0-5][0-9]$"
          )
        message: >
          Issue time must be provided as a split ISO 8601 datetime
          representation (non-standard time with offset).

    BT-702(a)-notice:
      - id: notice-official-language-main
        note: >
          See logical group 'notice-official-language' for related elements.
        logical-group: notice-official-language
        test: >
          matches(
            normalize-space(
              /*/cbc:NoticeLanguageCode
            ),
            "^(NOR|NNO|NOB)$"
          )
        message: >
          The main language of national notices beneath EEA threhsolds must be
          Norwegian.
        

    # Obligatoriske grupper
    groups:
      - id: procedure-legal-basis-choice
        mode: select-one
        logical-group: procedure-legal-basis
        note: >
          Either a CELEX reference (BT-01-notice)
          or a national legal basis pair (BT-01(e)-procedure and
          BT-01(f)-procedure) must be provided. In the latter case,
          BT-01-notice shall contain "other".
        members:
          - id: eu-legal-basis
            members:
              - BT-01-notice
            conditions:
              - test: >
                  matches(
                    normalize-space(
                      /*/cbc:RegulatoryDomain
                    ),
                    {{ bt-01-notice-notice-legal-basis-codes :except: 'other'}}
                  )
                message: >
                  BT-01-notice must contain a valid, non-`other` value from the
                  codelist.

          - id: national-legal-basis
            members:
              - BT-01-notice
              - BT-01(e)-procedure
              - BT-01(f)-procedure
            conditions:
              - test: >
                  matches(
                    normalize-space(
                      /*/cbc:RegulatoryDomain
                    ),
                    'other'
                  )
                message: >
                  BT-01-notice must be 'other' when national legal basis is
                  used.
              - test: >
                  matches(
                    normalize-space(
                      /*/cac:TenderingTerms/cac:ProcurementLegislationDocumentReference[cbc:ID/text()='LocalLegalBasis']/cbc:ID
                    ),
                    {{ bt-01-e-procedure-legal-basis-no-id-codes }}
                  )
                message: >
                  BT-01(e) must match a valid national legal basis code.
              - test: >
                  matches(
                    normalize-space(
                      /*/cac:TenderingTerms/cac:ProcurementLegislationDocumentReference[cbc:ID/text()='LocalLegalBasis']/cbc:DocumentDescription[cbc:languageID='NOR']
                    ),
                    {{ bt-01-f-procedure-legal-basis-no-id-description-codes }}
                  )
                message: >
                  BT-01(f) must match a valid national legal basis description
                  code.
              - test: >
                  let $e := normalize-space(
                      /*/cac:TenderingTerms/cac:ProcurementLegislationDocumentReference[cbc:ID/text()='LocalLegalBasis']/cbc:ID
                    )
                  let $f := normalize-space(
                      /*/cac:TenderingTerms/cac:ProcurementLegislationDocumentReference[cbc:ID/text()='LocalLegalBasis']/cbc:DocumentDescription[cbc:languageID='NOR']
                    )
                  return some $pair in << bt-01-e-procedure-legal-basis-no-id-codes >>
                         satisfies ($pair/id = $e and
                                    some $fpair in << bt-01-f-procedure-legal-basis-no-id-description-codes >>
                                    satisfies $fpair/id = $pair/id and $f = $fpair/code)
                message: >
                  BT-01(e) and BT-01(f) must refer to the same legal basis ID.

  optional:

    BT-702(b)-notice:
      - id: notice-official-language-additional
        note: >
          See logical group 'notice-official-language' for related elements.
        logical-group: notice-official-language
        test: >
          every $lang in /*/cac:AdditionalNoticeLanguage
          satisfies (
            normalize-space($lang/cbc:ID) = (
              'BUL', 'CES', 'DAN', 'DEU', 'ELL', 'ENG', 'EST', 'FIN', 'FRA',
              'GLE', 'HRV', 'HUN', 'ITA', 'LAV', 'LIT', 'MLT', 'NLD',
              'POL', 'POR', 'RON', 'SLK', 'SLV', 'SPA', 'SWE',
              'NOR', 'NOB', 'NNO'
            )
          )
        message: >
          Additional notice languages must be EU official or Norwegian
          (NOR/NOB/NNO).



