noticeTypes: [E2]

procedure-scope:
  - national-below-eea-threshold

include:
  - logical-groups/notice-versioning.yaml
  - logical-groups/notice-form-type.yaml
  
fields:
  OPT-002-notice:
    pattern:
      value: ^eforms-sdk-\d\.\d#extended#urn:fdc:anskaffelser.no:2023:eforms:national$

rules:
  # /*/cbc:CustomizationID
  OPT-002-notice:
    - id: EFORMS-NOR-R001
      test: matches(normalize-space(),'^eforms-sdk-\d\.(\d{1,2})#extended#urn:fdc:anskaffelser.no:2023:eforms:national$')
      message: Customization identifier must match the Norwegian accepted identifier

  # /*/cbc:NoticeLanguageCode
  BT-702(a)-notice:
    - id: EFORMS-NOR-R002
      test: normalize-space() = ('BUL', 'CES', 'DAN', 'DEU', 'ELL', 'ENG', 'EST', 'FIN', 'FRA', 'GLE', 'HRV', 'HUN', 'ITA', 'LAV', 'LIT', 'MLT', 'NLD', 'POL', 'POR', 'RON', 'SLK', 'SLV', 'SPA', 'SWE', 'NOR', 'NOB', 'NNO')
      message: Main language must be Norwegian or one of the official languages.

  # /*/cac:AdditionalNoticeLanguage/cbc:ID
  BT-702(b)-notice:
    - id: EFORMS-NOR-R003
      test: normalize-space() = ('BUL', 'CES', 'DAN', 'DEU', 'ELL', 'ENG', 'EST', 'FIN', 'FRA', 'GLE', 'HRV', 'HUN', 'ITA', 'LAV', 'LIT', 'MLT', 'NLD', 'POL', 'POR', 'RON', 'SLK', 'SLV', 'SPA', 'SWE', 'NOR', 'NOB', 'NNO')
      message: Additional language must be Norwegian or one of the official languages.

  # /*/ext:UBLExtensions/ext:UBLExtension/ext:ExtensionContent/efext:EformsExtension/efac:NoticeSubType/cbc:SubTypeCode
  OPP-070-notice:
    - id: EFORMS-NOR-R010
      test: normalize-space() = ('N4', 'N16', 'N29')
      message: Notice type must be N4, N16 or N29.

  # /*
  ND-Root:
    - id: EFORMS-NOR-R004
      test: normalize-space(cbc:NoticeLanguageCode) = ('NOR', 'NOB', 'NNO') or (some $l in cac:AdditionalNoticeLanguage/cbc:ID satisfies normalize-space($l) = ('NOR', 'NOB', 'NNO')) # then true() else false())
      message: At least one of the official lingustic versions must be in Norwegian.

    - id: EFORMS-NOR-R007
      test: not(/*/ext:UBLExtensions/ext:UBLExtension/ext:ExtensionContent/efext:EformsExtension/efac:NonOfficialLanguages)
      message: Non-official languages are not used for national notices.

  # /*/cbc:IssueDate
  BT-05(a)-notice:
    # Copied from stage 6b
    - id: EFORMS-NOR-R801
      test: ((current-date() - xs:date(text())) le xs:dayTimeDuration('P2D')) and ((current-date() - xs:date(text())) ge xs:dayTimeDuration('-P1D'))
      message: Notice Dispatch Date must be between 0 and 24 hours before the current date.

  BT-131(d)-Lot:
    - id: EFORMS-NOR-R200
      test: normalize-space() = /*/cac:ProcurementProjectLot[cbc:ID/@schemeName='Lot']/cac:TenderingProcess/cac:TenderSubmissionDeadlinePeriod/cbc:EndDate[1]/normalize-space()
      message: All lots must have same deadline
    
  BT-131(t)-Lot:
    - id: EFORMS-NOR-R201
      test: normalize-space() = /*/cac:ProcurementProjectLot[cbc:ID/@schemeName='Lot']/cac:TenderingProcess/cac:TenderSubmissionDeadlinePeriod/cbc:EndTime[1]/normalize-space()
      message: All lots must have same deadline

included:
  mandatory:
    # Notice related (BG-1 Notice)
    BT-701-notice:
      - id: notice-identifier
        note: >
          See logical-group 'notice-versioning' for related elements.
        logical-group: notice-versioning
        test: >
          matches(
            lower-case(
              normalize-space(
                /*/cbc:ID[@schemeName='notice-id']
              )
            ),
            "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
          )
        message: Notice Identifier must be a valid UUID4.

    BT-757-notice:
      - id: notice-version
        note: >
          See logical-group 'notice-versioning' for related elements.
        logical-group: notice-versioning
        test: >
          matches(
            normalize-space(
              /*/cbc:VersionID
            ),
            "^[0-9]{2}$"
          )
        message: >
          Notice Version must be a left-zero-padded
          two digit integer.

    BT-03-notice:
      - id: form-type
        note: >
          See logical group 'notice-form-type' for related elements.
        logical-group: 'notice-form-type'
        test: >
          matches(
            /*/cbc:NoticeType/@listName
            ),
            {{ bt-03-notice-form-type-codes }}
          )
        message: >
          Form type must be chosen as a valid code from the codelist.

    BT-02-notice:
      - id: notice-type
        note: >
          See logical group 'notice-form-type' for related elements.
          Note that the '@listName' attribute of the XML element is
          mapped in BT-03-notice.
        logical-group: 'notice-form-type'
        test: >
          matches(
            /*/cbc:NoticeType
            ),
            {{ bt-02-notice-notice-type-codes }}
          )
        message: >
          Notice type must be chosen as a valid code from the codelist.

    # Obligatoriske grupper
    groups:
      - id: notice-legal-basis-choice
        type: select-one
        note: >
          Either a CELEX reference (BT-01-notice)
          or a national legal basis pair (BT-01(e)-procedure and
          BT-01(f)-procedure) must be provided. In the latter case,
          BT-01-notice shall contain "other".
        logical-group: notice-legal-basis
        members:
          - BT-01-notice
          - [BT-01(e)-procedure, BT-01(f)-procedure]
        message: >
          One of the notice legal basis options must be supplied:
          CELEX (BT-01-notice), or a valid national legal basis pair.
        

  optional:



